#!/usr/bin/env python3
# ROBUSTNESS: Forcing 'xcb' platform to prevent Wayland/Qt GUI errors on Linux.
import os
os.environ['QT_QPA_PLATFORM'] = 'xcb'
"""
FaceAuth - Local Face Authentication System
===========================================

Main CLI interface for the FaceAuth system.
Provides commands for face enrollment, authentication, and file encryption.

Usage:
    python main.py enroll [--user-id USER] [--model MODEL]
    python main.py verify [--user-id USER]
    python main.py encrypt <filename> [--user-id USER]
    python main.py decrypt <filename> [--output PATH] [--user-id USER]
"""

import click
import sys
from pathlib import Path

# Add current directory to path for imports
sys.path.insert(0, str(Path(__file__).parent))

from faceauth.enrollment import enroll_new_user, FaceEnrollmentError


@click.group(invoke_without_command=True)
@click.version_option(version="1.0.0")
@click.option(
    "--gui",
    is_flag=True,
    help="Launch the graphical user interface instead of CLI"
)
@click.pass_context
def cli(ctx, gui):
    """
    üîê FaceAuth - Local Face Authentication System
    
    A privacy-first face authentication platform for securing your files.
    All processing happens locally - no cloud, no third parties.
    
    Use --gui flag to launch the graphical interface:
        python main.py --gui
    """
    if gui:
        # Launch GUI mode
        try:
            from faceauth.gui import FaceAuthGUI
            click.echo("üöÄ Launching FaceAuth GUI...")
            app = FaceAuthGUI()
            app.run()
            ctx.exit()
        except ImportError as e:
            click.echo("‚ùå Error: GUI dependencies not available")
            click.echo(f"   {str(e)}")
            click.echo("\nüí° To use GUI mode, ensure tkinter is installed:")
            click.echo("   sudo apt-get install python3-tk  # Ubuntu/Debian")
            click.echo("   brew install python-tk          # macOS")
            ctx.exit(1)
        except Exception as e:
            click.echo(f"‚ùå GUI Error: {str(e)}")
            ctx.exit(1)
    elif ctx.invoked_subcommand is None:
        # Show help if no command is provided and no GUI flag
        click.echo(ctx.get_help())


@cli.command("enroll")
@click.option(
    "--user-id", 
    "-u", 
    type=str, 
    help="Unique identifier for the user (will prompt if not provided)"
)
@click.option(
    "--model", 
    "-m", 
    type=click.Choice(["Facenet", "ArcFace", "VGG-Face", "Facenet512"], case_sensitive=False),
    default="Facenet",
    help="Face recognition model to use (default: Facenet)"
)
@click.option(
    "--data-dir",
    "-d",
    type=click.Path(),
    default="face_data",
    help="Directory to store face data (default: face_data)"
)
def enroll_face(user_id, model, data_dir):
    """
    Enroll a new user's face into the system.
    
    This command captures your face using the webcam, generates a secure
    face embedding, and stores it locally in encrypted format.
    
    The process takes about 30 seconds and requires:
    - A working webcam
    - Good lighting conditions
    - Only one person visible in the frame
    
    Examples:
        python main.py enroll
        python main.py enroll --user-id john_doe
        python main.py enroll --user-id alice --model ArcFace
    """
    click.echo("üöÄ Starting FaceAuth enrollment process...")
    click.echo("=" * 60)
    
    try:
        # Import here to avoid issues if dependencies aren't installed
        from faceauth.enrollment import FaceEnroller
        
        # Create enroller instance
        enroller = FaceEnroller(model_name=model, data_dir=data_dir)
        
        # Perform enrollment
        result = enroller.enroll_new_user(user_id)
        
        if result['success']:
            click.echo("\nüéâ SUCCESS!")
            click.echo(f"‚úÖ User '{result['user_id']}' enrolled successfully")
            click.echo(f"üìÅ Data saved to: {result['file_path']}")
            click.echo(f"üß† Model used: {result['model_used']}")
            click.echo(f"üìä Embedding size: {result['embedding_size']} dimensions")
            click.echo("\nüîí Your face data is encrypted and stored locally")
            click.echo("‚ö†Ô∏è  Keep your password safe - it cannot be recovered!")
            
            # Next steps
            click.echo("\nüìã Next steps:")
            click.echo("‚Ä¢ Test authentication: python main.py verify")
            click.echo("‚Ä¢ Encrypt files: python main.py encrypt myfile.txt")
            click.echo("‚Ä¢ View help: python main.py --help")
            
        else:
            click.echo("‚ùå Enrollment failed")
            sys.exit(1)
            
    except FaceEnrollmentError as e:
        click.echo(f"\n‚ùå Enrollment Error: {e}")
        
        # HARDENED: Provide specific guidance for common errors
        error_str = str(e)
        if "OpenCV data files missing" in error_str or "haarcascade" in error_str:
            click.echo("\nüö® CRITICAL ERROR: OpenCV Environment Corruption Detected!")
            click.echo("üí° IMMEDIATE FIX:")
            click.echo("   python main.py setup")
            click.echo("\nüìã What happened?")
            click.echo("‚Ä¢ Your OpenCV installation is missing essential data files")
            click.echo("‚Ä¢ This causes DeepFace to crash during face detection")
            click.echo("‚Ä¢ The setup command will completely reinstall OpenCV correctly")
            click.echo("\n‚ö° After running setup, enrollment will work perfectly!")
        else:
            click.echo("\nüí° Common solutions:")
            click.echo("‚Ä¢ Check if user is enrolled: python main.py info")
            click.echo("‚Ä¢ Verify webcam is working and not in use by another app")
            click.echo("‚Ä¢ Ensure good lighting conditions")
            click.echo("‚Ä¢ Try again: python main.py enroll")
        sys.exit(1)
    except ImportError as e:
        click.echo(f"\n‚ùå Missing dependencies: {e}")
        click.echo("üí° Please install required packages:")
        click.echo("   pip install -r requirements.txt")
        sys.exit(1)
    except KeyboardInterrupt:
        click.echo("\n\n‚ùå Enrollment cancelled by user")
        sys.exit(1)
    except Exception as e:
        click.echo(f"\nüí• Unexpected error: {e}")
        click.echo("üêõ Please report this issue if it persists")
        sys.exit(1)


@cli.command("verify")
@click.option(
    "--user-id", 
    "-u", 
    type=str, 
    help="User ID to verify against (will prompt if not provided)"
)
@click.option(
    "--model", 
    "-m", 
    type=click.Choice(["Facenet", "ArcFace", "VGG-Face", "Facenet512"], case_sensitive=False),
    default="Facenet",
    help="Face recognition model to use (default: Facenet)"
)
@click.option(
    "--data-dir",
    "-d",
    type=click.Path(),
    default="face_data",
    help="Directory containing face data (default: face_data)"
)
def verify_face(user_id, model, data_dir):
    """
    Verify your identity using face authentication.
    
    This command compares your current face against stored face data
    to authenticate your identity. The verification process is fast
    and secure, completing in under 2 seconds.
    
    Requirements:
    - Enrolled face data (use 'enroll' first)
    - Working webcam
    - Good lighting conditions
    - Your enrollment password
    
    Examples:
        python main.py verify
        python main.py verify --user-id john_doe
        python main.py verify --user-id alice --model ArcFace
    """
    click.echo("üîç Starting FaceAuth verification process...")
    click.echo("=" * 60)
    
    try:
        # Import authentication module
        from faceauth.authentication import FaceAuthenticator, FaceAuthenticationError
        
        # Create authenticator instance
        authenticator = FaceAuthenticator(model_name=model, data_dir=data_dir)
        
        # Perform verification
        click.echo("üöÄ Initializing face authentication...")
        verification_result = authenticator.verify_user_face(user_id)
        
        # Display results
        if verification_result:
            click.echo("\nüéâ SUCCESS!")
            click.echo("‚úÖ ACCESS GRANTED")
            click.echo("üîì Identity verified successfully")
            click.echo(f"üß† Model used: {model}")
            click.echo("‚ö° Verification completed in under 2 seconds")
            
            # Success message
            click.echo("\nüåü Authentication successful!")
            click.echo("üí° You can now use secure features:")
            click.echo("‚Ä¢ Encrypt files: python main.py encrypt myfile.txt")
            click.echo("‚Ä¢ Access protected resources")
            
        else:
            click.echo("\n‚ùå FAILURE!")
            click.echo("üö´ ACCESS DENIED")
            click.echo("‚ö†Ô∏è  Identity could not be verified")
            
            # Failure guidance
            click.echo("\nüí° Troubleshooting tips:")
            click.echo("‚Ä¢ Ensure good lighting conditions")
            click.echo("‚Ä¢ Position face clearly in camera view")
            click.echo("‚Ä¢ Remove glasses/masks if possible")
            click.echo("‚Ä¢ Try re-enrolling: python main.py enroll")
            
            sys.exit(1)
            
    except FaceAuthenticationError as e:
        click.echo(f"\n‚ùå Authentication Error: {e}")
        click.echo("\nüí° Common solutions:")
        click.echo("‚Ä¢ Check if user is enrolled: python main.py info")
        click.echo("‚Ä¢ Enroll first: python main.py enroll")
        click.echo("‚Ä¢ Verify password is correct")
        click.echo("‚Ä¢ Ensure webcam is working")
        sys.exit(1)
    except ImportError as e:
        click.echo(f"\n‚ùå Missing dependencies: {e}")
        click.echo("üí° Please install required packages:")
        click.echo("   pip install -r requirements.txt")
        click.echo("   python main.py setup")
        sys.exit(1)
    except KeyboardInterrupt:
        click.echo("\n\n‚ùå Verification cancelled by user")
        sys.exit(1)
    except Exception as e:
        click.echo(f"\nüí• Unexpected error: {e}")
        click.echo("üêõ Please report this issue if it persists")
        sys.exit(1)


@cli.command("encrypt")
@click.argument("filename", type=click.Path(exists=True))
@click.option(
    "--user-id", 
    "-u", 
    type=str, 
    help="User ID for face authentication (will prompt if not provided)"
)
@click.option(
    "--model", 
    "-m", 
    type=click.Choice(["Facenet", "ArcFace", "VGG-Face", "Facenet512"], case_sensitive=False),
    default="Facenet",
    help="Face recognition model to use (default: Facenet)"
)
@click.option(
    "--data-dir",
    "-d",
    type=click.Path(),
    default="face_data",
    help="Directory containing face data (default: face_data)"
)
def encrypt_file(filename, user_id, model, data_dir):
    """
    Encrypt a file using face authentication.
    
    This command first authenticates your identity using face verification,
    then encrypts the specified file with a secure key wrapping approach.
    The encrypted file will have a .faceauth extension.
    
    Security Process:
    1. Face authentication to verify your identity
    2. Password prompt for key derivation
    3. File encryption with AES-256-GCM
    4. Secure key wrapping to protect encryption keys
    
    Examples:
        python main.py encrypt secret.txt
        python main.py encrypt document.pdf --user-id alice
        python main.py encrypt data.csv --user-id bob --model ArcFace
    """
    click.echo("üîí Starting FaceAuth file encryption process...")
    click.echo("=" * 60)
    
    try:
        # Import required modules
        from faceauth.authentication import FaceAuthenticator, FaceAuthenticationError
        from faceauth.file_handler import encrypt_file as encrypt_file_func, FileEncryptionError
        import getpass
        from pathlib import Path
        
        # Step 1: Face Authentication Gate
        click.echo("üîç Step 1: Face Authentication Required")
        click.echo("‚ö†Ô∏è  You must verify your identity before encrypting files")
        click.echo()
        
        # Create authenticator instance
        authenticator = FaceAuthenticator(model_name=model, data_dir=data_dir)
        
        # Perform face verification
        click.echo("üöÄ Starting face verification...")
        verification_success = authenticator.verify_user_face(user_id)
        
        if not verification_success:
            click.echo("\n‚ùå AUTHENTICATION FAILED")
            click.echo("üö´ File encryption requires successful face verification")
            click.echo("\nüí° Troubleshooting:")
            click.echo("‚Ä¢ Ensure you are enrolled: python main.py enroll-face")
            click.echo("‚Ä¢ Check lighting and camera positioning")
            click.echo("‚Ä¢ Verify your password is correct")
            sys.exit(1)
        
        click.echo("\n‚úÖ AUTHENTICATION SUCCESSFUL")
        click.echo("üîì Access granted for file encryption")
        
        # Step 2: Get encryption password
        click.echo("\nüîê Step 2: Password for File Encryption")
        click.echo("Enter the password to protect your encrypted file:")
        click.echo("(This can be the same as your enrollment password or different)")
        
        encryption_password = getpass.getpass("Encryption password: ")
        if not encryption_password:
            click.echo("‚ùå Password is required for file encryption")
            sys.exit(1)
        
        # Confirm password
        password_confirm = getpass.getpass("Confirm password: ")
        if encryption_password != password_confirm:
            click.echo("‚ùå Passwords do not match")
            sys.exit(1)
        
        # Step 3: Encrypt the file
        click.echo("\nüîí Step 3: Encrypting File")
        click.echo(f"üìÅ Input file: {filename}")
        
        # Get file info
        input_path = Path(filename)
        file_size = input_path.stat().st_size
        click.echo(f"üìä File size: {file_size:,} bytes")
        
        # Perform encryption
        click.echo("‚ö° Encrypting with AES-256-GCM...")
        encrypted_file_path = encrypt_file_func(filename, encryption_password)
        
        # Success report
        encrypted_path = Path(encrypted_file_path)
        encrypted_size = encrypted_path.stat().st_size
        
        click.echo("\nüéâ ENCRYPTION SUCCESSFUL!")
        click.echo("‚úÖ File encrypted and secured")
        click.echo(f"üìÅ Original file: {filename}")
        click.echo(f"üîí Encrypted file: {encrypted_file_path}")
        click.echo(f"üìä Original size: {file_size:,} bytes")
        click.echo(f"üìä Encrypted size: {encrypted_size:,} bytes")
        click.echo(f"üîê Encryption overhead: {encrypted_size - file_size} bytes")
        
        # Security information
        click.echo("\nüõ°Ô∏è  Security Information:")
        click.echo("‚Ä¢ File encrypted with AES-256-GCM")
        click.echo("‚Ä¢ Unique encryption key generated per file")
        click.echo("‚Ä¢ Key protected with PBKDF2 (100,000 iterations)")
        click.echo("‚Ä¢ Original file remains unchanged")
        
        # Next steps
        click.echo("\nüìã Next Steps:")
        click.echo(f"‚Ä¢ Decrypt: python main.py decrypt-file {encrypted_file_path}")
        click.echo("‚Ä¢ Store your password securely - it cannot be recovered")
        click.echo("‚Ä¢ Keep the .faceauth file safe")
        
        # Optional: Ask about deleting original
        click.echo("\nüóëÔ∏è  Security Recommendation:")
        if click.confirm("Delete the original unencrypted file for security?"):
            try:
                input_path.unlink()
                click.echo(f"‚úÖ Original file '{filename}' securely deleted")
            except Exception as e:
                click.echo(f"‚ö†Ô∏è  Could not delete original file: {e}")
                click.echo("üí° Please delete it manually for security")
        
    except FaceAuthenticationError as e:
        click.echo(f"\n‚ùå Authentication Error: {e}")
        click.echo("\nüí° Solutions:")
        click.echo("‚Ä¢ Enroll first: python main.py enroll-face")
        click.echo("‚Ä¢ Check webcam connectivity")
        click.echo("‚Ä¢ Ensure good lighting")
        sys.exit(1)
    except FileEncryptionError as e:
        click.echo(f"\n‚ùå Encryption Error: {e}")
        click.echo("\nüí° Possible causes:")
        click.echo("‚Ä¢ File is in use by another program")
        click.echo("‚Ä¢ Insufficient disk space")
        click.echo("‚Ä¢ Invalid file permissions")
        sys.exit(1)
    except ImportError as e:
        click.echo(f"\n‚ùå Missing dependencies: {e}")
        click.echo("üí° Please install required packages:")
        click.echo("   pip install -r requirements.txt")
        sys.exit(1)
    except KeyboardInterrupt:
        click.echo("\n\n‚ùå Encryption cancelled by user")
        sys.exit(1)
    except Exception as e:
        click.echo(f"\nüí• Unexpected error: {e}")
        click.echo("üêõ Please report this issue if it persists")
        sys.exit(1)


@cli.command("decrypt")
@click.argument("filename", type=click.Path(exists=True))
@click.option(
    "--output", 
    "-o", 
    type=click.Path(),
    help="Output path for decrypted file (optional)"
)
@click.option(
    "--user-id", 
    "-u", 
    type=str, 
    help="User ID for face authentication (will prompt if not provided)"
)
@click.option(
    "--model", 
    "-m", 
    type=click.Choice(["Facenet", "ArcFace", "VGG-Face", "Facenet512"], case_sensitive=False),
    default="Facenet",
    help="Face recognition model to use (default: Facenet)"
)
@click.option(
    "--data-dir",
    "-d",
    type=click.Path(),
    default="face_data",
    help="Directory containing face data (default: face_data)"
)
def decrypt_file(filename, output, user_id, model, data_dir):
    """
    Decrypt a file using face authentication.
    
    This command first authenticates your identity using face verification,
    then decrypts a .faceauth encrypted file using your password.
    
    Security Process:
    1. Face authentication to verify your identity
    2. Password prompt for key derivation
    3. File decryption with AES-256-GCM
    4. Secure key unwrapping to access encryption keys
    
    Examples:
        python main.py decrypt secret.txt.faceauth
        python main.py decrypt document.pdf.faceauth --output document.pdf
        python main.py decrypt data.csv.faceauth --user-id alice
    """
    click.echo("üîì Starting FaceAuth file decryption process...")
    click.echo("=" * 60)
    
    try:
        # Import required modules
        from faceauth.authentication import FaceAuthenticator, FaceAuthenticationError
        from faceauth.file_handler import decrypt_file as decrypt_file_func, FileEncryptionError, get_encrypted_file_info
        import getpass
        from pathlib import Path
        
        # Validate input file
        if not filename.endswith('.faceauth'):
            click.echo("‚ö†Ô∏è  Warning: File doesn't have .faceauth extension")
            if not click.confirm("Continue anyway?"):
                sys.exit(0)
        
        # Get file information
        click.echo("üìã Encrypted File Information:")
        try:
            file_info = get_encrypted_file_info(filename)
            click.echo(f"üìÅ File: {file_info['file_path']}")
            click.echo(f"üìä Size: {file_info['file_size']:,} bytes")
            click.echo(f"‚úÖ Valid format: {file_info['is_valid_format']}")
            
            if not file_info['is_valid_format']:
                click.echo("‚ùå Invalid .faceauth file format")
                sys.exit(1)
                
        except FileEncryptionError as e:
            click.echo(f"‚ùå Cannot read encrypted file: {e}")
            sys.exit(1)
        
        # Step 1: Face Authentication Gate
        click.echo("\nüîç Step 1: Face Authentication Required")
        click.echo("‚ö†Ô∏è  You must verify your identity before decrypting files")
        click.echo()
        
        # Create authenticator instance
        authenticator = FaceAuthenticator(model_name=model, data_dir=data_dir)
        
        # Perform face verification
        click.echo("üöÄ Starting face verification...")
        verification_success = authenticator.verify_user_face(user_id)
        
        if not verification_success:
            click.echo("\n‚ùå AUTHENTICATION FAILED")
            click.echo("üö´ File decryption requires successful face verification")
            click.echo("\nüí° Troubleshooting:")
            click.echo("‚Ä¢ Ensure you are enrolled: python main.py enroll-face")
            click.echo("‚Ä¢ Check lighting and camera positioning")
            click.echo("‚Ä¢ Verify your password is correct")
            sys.exit(1)
        
        click.echo("\n‚úÖ AUTHENTICATION SUCCESSFUL")
        click.echo("üîì Access granted for file decryption")
        
        # Step 2: Get decryption password
        click.echo("\nüîê Step 2: Password for File Decryption")
        click.echo("Enter the password used to encrypt this file:")
        
        decryption_password = getpass.getpass("Decryption password: ")
        if not decryption_password:
            click.echo("‚ùå Password is required for file decryption")
            sys.exit(1)
        
        # Step 3: Decrypt the file
        click.echo("\nüîì Step 3: Decrypting File")
        click.echo(f"üìÅ Encrypted file: {filename}")
        
        # Perform decryption
        click.echo("‚ö° Decrypting with AES-256-GCM...")
        decrypted_file_path = decrypt_file_func(filename, decryption_password, output)
        
        # Success report
        decrypted_path = Path(decrypted_file_path)
        decrypted_size = decrypted_path.stat().st_size
        
        click.echo("\nüéâ DECRYPTION SUCCESSFUL!")
        click.echo("‚úÖ File decrypted and restored")
        click.echo(f"üîí Encrypted file: {filename}")
        click.echo(f"üîì Decrypted file: {decrypted_file_path}")
        click.echo(f"üìä Decrypted size: {decrypted_size:,} bytes")
        
        # Security information
        click.echo("\nüõ°Ô∏è  Security Information:")
        click.echo("‚Ä¢ File decrypted using AES-256-GCM")
        click.echo("‚Ä¢ Encryption keys securely derived from password")
        click.echo("‚Ä¢ Authentication tag verified for integrity")
        click.echo("‚Ä¢ Original encrypted file remains unchanged")
        
        # Next steps
        click.echo("\nüìã Next Steps:")
        click.echo("‚Ä¢ Your file has been successfully restored")
        click.echo("‚Ä¢ Keep the .faceauth file as backup if needed")
        click.echo("‚Ä¢ Consider re-encrypting if security is compromised")
        
    except FaceAuthenticationError as e:
        click.echo(f"\n‚ùå Authentication Error: {e}")
        click.echo("\nüí° Solutions:")
        click.echo("‚Ä¢ Enroll first: python main.py enroll-face")
        click.echo("‚Ä¢ Check webcam connectivity")
        click.echo("‚Ä¢ Ensure good lighting")
        sys.exit(1)
    except FileEncryptionError as e:
        click.echo(f"\n‚ùå Decryption Error: {e}")
        click.echo("\nüí° Common causes and solutions:")
        click.echo("‚Ä¢ Wrong password - try again with correct password")
        click.echo("‚Ä¢ Corrupted file - restore from backup if available")
        click.echo("‚Ä¢ Invalid file format - ensure file was encrypted with FaceAuth")
        click.echo("‚Ä¢ File tampering - check file integrity")
        sys.exit(1)
    except ImportError as e:
        click.echo(f"\n‚ùå Missing dependencies: {e}")
        click.echo("üí° Please install required packages:")
        click.echo("   pip install -r requirements.txt")
        sys.exit(1)
    except KeyboardInterrupt:
        click.echo("\n\n‚ùå Decryption cancelled by user")
        sys.exit(1)
    except Exception as e:
        click.echo(f"\nüí• Unexpected error: {e}")
        click.echo("üêõ Please report this issue if it persists")
        sys.exit(1)


@cli.command("info")
def info():
    """
    üìä Display system information and status.
    """
    click.echo("üîê FaceAuth System Information")
    click.echo("=" * 40)
    
    # Check Python version
    python_version = f"{sys.version_info.major}.{sys.version_info.minor}.{sys.version_info.micro}"
    click.echo(f"üêç Python version: {python_version}")
    
    # Check if face_data directory exists
    face_data_dir = Path("face_data")
    if face_data_dir.exists():
        face_files = list(face_data_dir.glob("*_face.dat"))
        click.echo(f"üìÅ Face data directory: {face_data_dir.absolute()}")
        click.echo(f"üë• Enrolled users: {len(face_files)}")
    else:
        click.echo("üìÅ Face data directory: Not created yet")
        click.echo("üë• Enrolled users: 0")
    
    # Check dependencies
    click.echo("\nüì¶ Dependencies:")
    required_packages = ["cv2", "deepface", "numpy", "cryptography", "click"]
    
    for package in required_packages:
        try:
            if package == "cv2":
                import cv2
                click.echo(f"‚úÖ OpenCV: {cv2.__version__}")
            elif package == "deepface":
                import deepface
                click.echo(f"‚úÖ DeepFace: Available")
            elif package == "numpy":
                import numpy
                click.echo(f"‚úÖ NumPy: {numpy.__version__}")
            elif package == "cryptography":
                import cryptography
                click.echo(f"‚úÖ Cryptography: {cryptography.__version__}")
            elif package == "click":
                import click as click_pkg
                click.echo(f"‚úÖ Click: {click_pkg.__version__}")
        except ImportError:
            click.echo(f"‚ùå {package}: Not installed")
    
    click.echo("\nüîó Quick Start:")
    click.echo("1. üîß Fix environment: python main.py setup  (Run this first if ANY issues!)")
    click.echo("2. ‚úÖ Check status: python main.py info")
    click.echo("3. üë§ Enroll your face: python main.py enroll")
    click.echo("4. üìñ Get help: python main.py --help")
    
    click.echo("\nüö® Having Issues?")
    click.echo("üí° The setup command is your repair tool - it fixes ALL dependency problems!")
    click.echo("   python main.py setup")


@cli.command("setup")
def setup():
    """
    üõ†Ô∏è Setup and install FaceAuth dependencies.
    
    This command performs a complete environment repair by:
    1. Aggressively removing conflicting OpenCV installations
    2. Upgrading pip to the latest version
    3. Installing all dependencies from a clean state
    
    ‚ö° CRITICAL: This command fixes the "haarcascade_frontalface_default.xml" 
    error that causes enrollment to crash.
    
    Run this command whenever you encounter dependency errors.
    """
    import subprocess
    click.echo("üõ†Ô∏è FaceAuth Environment Repair & Setup")
    click.echo("=" * 50)
    click.echo("This will clean your environment and install all dependencies correctly.")
    click.echo("‚è±Ô∏è  This may take a few minutes...\n")

    # Step 1: Aggressively clean up any conflicting OpenCV installations (nuke and pave)
    click.echo("üßπ Step 1: Force-cleaning conflicting OpenCV installations...")
    click.echo("Removing: opencv-python, opencv-python-headless, opencv-contrib-python, opencv-contrib-python-headless")
    
    try:
        result_uninstall = subprocess.run([
            sys.executable, "-m", "pip", "uninstall", 
            "opencv-python", "opencv-python-headless", 
            "opencv-contrib-python", "opencv-contrib-python-headless", "-y"
        ], capture_output=True, text=True, check=False)
        
        if result_uninstall.stdout.strip():
            click.echo("Removed packages:")
            click.echo(result_uninstall.stdout)
        else:
            click.echo("No conflicting OpenCV packages found.")
            
        click.echo("‚úÖ OpenCV cleanup complete.")
        
    except Exception as e:
        click.echo(f"‚ö†Ô∏è  Could not uninstall OpenCV packages: {e}")
        click.echo("Proceeding with setup...")

    # Step 2: Upgrade pip
    click.echo("\nüì¶ Step 2: Upgrading pip to latest version...")
    try:
        result_pip = subprocess.run([
            sys.executable, "-m", "pip", "install", "--upgrade", "pip"
        ], capture_output=True, text=True, check=False)
        
        if result_pip.returncode == 0:
            click.echo("‚úÖ pip upgraded successfully!")
        else:
            click.echo("‚ùå Failed to upgrade pip:")
            click.echo(result_pip.stderr)
            click.echo("\nüí° Try manually: python -m pip install --upgrade pip")
            sys.exit(1)
            
    except Exception as e:
        click.echo(f"‚ùå pip upgrade failed: {e}")
        click.echo("üí° Try manually: python -m pip install --upgrade pip")
        sys.exit(1)

    # Step 3: Validate requirements.txt exists
    if not Path("requirements.txt").exists():
        click.echo("‚ùå requirements.txt not found")
        click.echo("üí° Please ensure you're in the FaceAuth directory")
        sys.exit(1)

    # Step 4: Install all dependencies from clean state
    click.echo("\nüîß Step 3: Installing all project dependencies from clean state...")
    click.echo("üì¶ Installing from requirements.txt...")
    
    try:
        result = subprocess.run([
            sys.executable, "-m", "pip", "install", "-r", "requirements.txt"
        ], capture_output=True, text=True, check=False)
        
        # Show installation output
        if result.stdout.strip():
            click.echo("Installation log:")
            click.echo(result.stdout)
            
        if result.returncode == 0:
            click.echo("\nüéâ SETUP COMPLETE!")
            click.echo("‚úÖ All dependencies are freshly installed and ready")
            click.echo("üîß Environment repair successful")
            
            # Next steps
            click.echo("\nüöÄ Next Steps:")
            click.echo("1. Test the setup: python main.py info")
            click.echo("2. Enroll your face: python main.py enroll")
            click.echo("3. Start using FaceAuth!")
            
            click.echo("\nüí° If you encounter ANY error in the future:")
            click.echo("   Just run 'python main.py setup' again to fix it.")
            
        else:
            click.echo("\n‚ùå CRITICAL ERROR: Dependency installation failed")
            click.echo("Error details:")
            click.echo(result.stderr)
            click.echo("\nÔøΩ Troubleshooting:")
            click.echo("1. Ensure you have an active internet connection")
            click.echo("2. Try manually: pip install -r requirements.txt")
            click.echo("3. Check if you're in a virtual environment")
            click.echo("4. Verify Python version compatibility (3.8+)")
            sys.exit(1)
            
    except Exception as e:
        click.echo(f"\n‚ùå Setup failed with exception: {e}")
        click.echo("\nÔøΩ Manual recovery:")
        click.echo("   pip install -r requirements.txt")
        sys.exit(1)


def main():
    """Main entry point for the CLI."""
    try:
        cli()
    except KeyboardInterrupt:
        click.echo("\n\nüëã Goodbye!")
        sys.exit(0)
    except Exception as e:
        click.echo(f"\nüí• Unexpected error: {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()
